no cache
got results getAll [ { tujuan: 'Jakarta  (CGK) to Surabaya (SUB)',
    totalIDR: '451600',
    depart: 
     { departKode: 'QZ 7680 ',
       date: [Object],
       fare: [Object],
       addOns: [Object],
       total: '451600 ',
       taxesAndFees: [Object] } },
  { tujuan: 'Jakarta  (CGK) to Surabaya (SUB)',
    totalIDR: '903200',
    depart: 
     { departKode: 'QZ 7680 ',
       date: [Object],
       fare: [Object],
       addOns: [Object],
       total: '903200 ',
       taxesAndFees: [Object] } },
  { tujuan: 'Jakarta  (CGK) to Surabaya (SUB)',
    totalIDR: '601600',
    depart: 
     { departKode: 'QZ 7680 ',
       date: [Object],
       fare: [Object],
       addOns: [Object],
       total: '601600 ',
       taxesAndFees: [Object] } } ]
savecache {"_index":"pluto","_type":"price","_id":"jogpnklionabcxx","_version":1,"created":true} { origin: 'jog',
  destination: 'pnk',
  airline: 'lion',
  flight: 'abc',
  class: 'xx',
  prices: { adult: 1000004, child: 1000004, infant: 50004, basic: 1000004 },
  price: 1000004,
  id: 'jogpnklionabcxx' }
no cache
savecache {"_index":"pluto","_type":"price","_id":"cgksubairasia","_version":1,"created":true} { origin: 'CGK',
  destination: 'SUB',
  airline: 'airasia',
  flight: '',
  class: '',
  prices: { adult: 451601, child: 451601, infant: 150001, basic: 339001 },
  price: 451601,
  id: 'cgksubairasia' }
got results getAll [ { dep_price: { adult_basic: [Object], passenger_tax: [Object] },
    total: '681700' },
  { dep_price: 
     { adult_basic: [Object],
       child_basic: [Object],
       passenger_tax: [Object] },
    total: '1231400' },
  { dep_price: 
     { adult_basic: [Object],
       infant_basic: [Object],
       infant_tax: [Object],
       passenger_tax: [Object] },
    total: '906700' } ]
{ adult: 681700, child: 549700, infant: 225000, basic: 480000 }
no cache
savecache {"_index":"pluto","_type":"price","_id":"subcgkcitilink","_version":1,"created":true} { origin: 'SUB',
  destination: 'CGK',
  airline: 'citilink',
  flight: '',
  class: '',
  prices: { adult: 681702, child: 549702, infant: 225002, basic: 480002 },
  price: 681702,
  id: 'subcgkcitilink' }
got results getAll [ { total: 840000,
    departure: 
     { date: '2014-11-30',
       depart: '11/30/2014 9:10:00 AM',
       arrival: '11/30/2014 10:50:00 AM',
       adultFare: 685091,
       totalFax: 79000,
       totalVAT: 75909,
       total: 840000 } },
  { total: 1680000,
    departure: 
     { date: '2014-11-30',
       depart: '11/30/2014 9:10:00 AM',
       arrival: '11/30/2014 10:50:00 AM',
       adultFare: 685091,
       totalFax: 158000,
       totalVAT: 151818,
       total: 1680000,
       childFare: 685091 } },
  { total: 975000,
    departure: 
     { date: '2014-11-30',
       depart: '11/30/2014 9:10:00 AM',
       arrival: '11/30/2014 10:50:00 AM',
       adultFare: 685091,
       totalFax: 84000,
       totalVAT: 87727,
       total: 975000,
       infantFare: 118182 } } ]
savecache {"_index":"pluto","_type":"price","_id":"jogpnkexpress","_version":1,"created":true} { origin: 'JOG',
  destination: 'PNK',
  airline: 'express',
  flight: '',
  class: '',
  prices: { adult: 840000, child: 840000, infant: 135000, basic: 685091 },
  price: 840000,
  id: 'jogpnkexpress' }
no cache
no cache
got results getAll [ { basic: 2616000, tax: 266600, total: 2882600 },
  { basic: 4578000, tax: 467800, total: 5045800 },
  { basic: 2878000, tax: 297800, total: 3175800 } ]
savecache {"_index":"pluto","_type":"price","_id":"cgkjoggaruda","_version":1,"created":true} { origin: 'cgk',
  destination: 'jog',
  airline: 'garuda',
  flight: '',
  class: '',
  prices: { adult: 2882603, child: 2163203, infant: 293203, basic: 2616003 },
  price: 2882603,
  id: 'cgkjoggaruda' }
[{"price":{"published_fare":"1,326,700","total_taxes":"92,000","total":"1,418,700"}}]
[{"price":{"published_fare":"2,653,400","total_taxes":"184,000","total":"2,837,400"}}]
[{"price":{"published_fare":"1,458,700","total_taxes":"117,000","total":"1,575,700"}}]
got results getAll [ { published_fare: 1326700, total_taxes: 92000, total: 1418700 },
  { published_fare: 2653400, total_taxes: 184000, total: 2837400 },
  { published_fare: 1458700, total_taxes: 117000, total: 1575700 } ]
{ adult: 1418700, child: 1418700, infant: 157000, basic: 1326700 }
no cache
savecache {"_index":"pluto","_type":"price","_id":"subcgklion","_version":1,"created":true} { origin: 'SUB',
  destination: 'CGK',
  airline: 'lion',
  flight: '',
  class: '',
  prices: { adult: 1418704, child: 1418704, infant: 157004, basic: 1326704 },
  price: 1418704,
  id: 'subcgklion' }
got results getAll [ { itenari: { oneway: [Object], ret: [Object] },
    price: { total: '587,200', nta: '554,600' },
    faredetail: 
     { adult: [Object],
       child: [Object],
       infants: [Object],
       toTal: '587,200IDR',
       nta: '554,600IDR',
       diskonAgen: '32,600IDR' } },
  { itenari: { oneway: [Object], ret: [Object] },
    price: { total: '1,174,400', nta: '1,109,200' },
    faredetail: 
     { adult: [Object],
       child: [Object],
       infants: [Object],
       toTal: '1,174,400IDR',
       nta: '1,109,200IDR',
       diskonAgen: '65,200IDR' } },
  { itenari: { oneway: [Object], ret: [Object] },
    price: { total: '587,200', nta: '554,600' },
    faredetail: 
     { adult: [Object],
       child: [Object],
       infants: [Object],
       toTal: '587,200IDR',
       nta: '554,600IDR',
       diskonAgen: '32,600IDR' } } ]
Not saved. Requirements not met. { adult: 587200, child: 587200, infant: 0, basic: 452000 }
{ adult: 587200, child: 587200, infant: 0, basic: 452000 }
# TOC
   - [Airasia](#airasia)
     - [run](#airasia-run)
   - [base class](#base-class)
     - [init](#base-class-init)
     - [setOptions](#base-class-setoptions)
     - [setOption](#base-class-setoption)
     - [setMode](#base-class-setmode)
     - [prepareRequestData](#base-class-preparerequestdata)
     - [prepareRequestQuery](#base-class-preparerequestquery)
     - [prepareDatabaseQuery](#base-class-preparedatabasequery)
     - [preparePricesOutputFromDB](#base-class-preparepricesoutputfromdb)
     - [getCache](#base-class-getcache)
     - [preparePricesInputToDB](#base-class-preparepricesinputtodb)
     - [saveCache](#base-class-savecache)
     - [generateId](#base-class-generateid)
     - [get](#base-class-get)
     - [calculatePrices](#base-class-calculateprices)
     - [isCacheComplete](#base-class-iscachecomplete)
   - [Citilink](#citilink)
     - [run](#citilink-run)
   - [Express](#express)
     - [run](#express-run)
   - [Garuda](#garuda)
     - [run](#garuda-run)
   - [Lion](#lion)
     - [run](#lion-run)
   - [Sriwijaya](#sriwijaya)
     - [run](#sriwijaya-run)
<a name=""></a>
 
<a name="airasia"></a>
# Airasia
<a name="airasia-run"></a>
## run
should check db and then scrape and then save .

```js
var dt = {
	rute       : 'OW',
	ori        : 'CGK',
	dst        : 'SUB',
	adult      : '1',
	child      : '0',
	infant     : '0',
	dep_date   : '30+11+2014',
	id_maskapai: '9',
	user       : 'apwqz',
	id_maskapai: '9',
	rute       : 'OW',
	dep_radio  : '1_1',
	_          : '1416361230832',
}
var urlAirbinder = 'http://128.199.251.75:99/price';
var urlPluto = 'http://pluto.dev/0/price/airasia';
var options = {
	scrape: urlAirbinder,
	dt: dt,
	airline: 'airasia'
};
var airasia = new Airasia(options);
airasia.run()
	.then(function (prices) {
		// console.log(prices);
		expect(prices.adult).to.exist;
		expect(prices.child).to.exist;
		expect(prices.infant).to.exist;
		expect(prices.basic).to.exist;
		next();
	})
	.catch(function (err) {
		return next(err);
	});
```

<a name="base-class"></a>
# base class
<a name="base-class-init"></a>
## init
should have property based on defaults.

```js
var base = new Base();
expect(base.scrape).to.exist;
expect(base.dt).to.exist;
expect(base.dt.ori).to.exist;
expect(base.dt.dst).to.exist;
expect(base.airline).to.exist;
next();
```

should have property based on options.

```js
var url     = 'http://pluto.dev/price/flight';
var options = {
	scrape : url,
	dt     : {ori: 'cgk', dst: 'sub'},
	airline: 'garuda'
}
var base = new Base(options);
expect(base.scrape).to.eq(url);
expect(base.dt.ori).to.eq('cgk');
expect(base.dt.dst).to.eq('sub');
expect(base.airline).to.eq('garuda');
next();
```

should accept options with type a function.

```js
var scrapeFn = function(){return 'ok'; };
var options  = {
	scrape : scrapeFn
}
var base = new Base(options);
expect(base.scrape.toString()).to.eq(scrapeFn.toString());
next();
```

<a name="base-class-setoptions"></a>
## setOptions
should accepts object.

```js
var base    = new Base;
var url     = 'http://pluto.dev/price/flight';
var options = {scrape : url, }
base.setOptions(options);
expect(base.scrape).to.eq(url);
next();
```

should accepts strings.

```js
var base    = new Base;
var url     = 'http://pluto.dev/price/garuda';
var url2    = 'http://pluto.dev/price/airasia';
var options = {scrape : url, }
base.setOptions(options);
expect(base.scrape).to.eq(url);
base.setOptions('scrape', url2);
expect(base.scrape).to.eq(url2);
next();
```

<a name="base-class-setoption"></a>
## setOption
should accepts object.

```js
var base    = new Base;
var url     = 'http://pluto.dev/price/flight';
var options = {scrape : url, }
base.setOption(options);
expect(base.scrape).to.eq(url);
next();
```

should accepts strings.

```js
var base    = new Base;
var url     = 'http://pluto.dev/price/garuda';
var url2    = 'http://pluto.dev/price/airasia';
var options = {scrape : url, }
base.setOption(options);
expect(base.scrape).to.eq(url);
base.setOption('scrape', url2);
expect(base.scrape).to.eq(url2);
next();
```

<a name="base-class-setmode"></a>
## setMode
should set mode by default if undefined.

```js
var base = new Base;
base.setMode();
expect(base.dt.adult).to.eq('1');
expect(base.dt.child).to.eq('0');
expect(base.dt.infant).to.eq('0');
next();
```

should set mode by default if passed weird thing -- object.

```js
var base = new Base;
base.setMode({});
expect(base.dt.adult).to.eq('1');
next();
```

should set mode by default if passed weird thing -- string.

```js
var base = new Base;
base.setMode('asdadsa');
expect(base.dt.adult).to.eq('1');
next();
```

should set mode by default if passed weird thing -- function.

```js
var base = new Base;
base.setMode(console.log);
expect(base.dt.adult).to.eq('1');
next();
```

<a name="base-class-preparerequestdata"></a>
## prepareRequestData
should prepare data for scrape function.

```js
var url     = 'http://pluto.dev/price/flight';
var options = {
	scrape : url,
	dt     : {ori: 'cgk', dst: 'sub'},
	airline: 'garuda'
}
var base = new Base(options);
var data = base.prepareRequestData();
expect(data.airline).to.eq('garuda');
expect(data.action).to.eq('price');
expect(data.query.ori).to.eq('cgk');
expect(data.query.dst).to.eq('sub');
next();
```

<a name="base-class-preparerequestquery"></a>
## prepareRequestQuery
should prepare query for request function.

```js
var url     = 'http://pluto.dev/price/flight';
var options = {
	scrape : url,
	dt     : {ori: 'cgk', dst: 'sub'},
	airline: 'garuda'
}
var base = new Base(options);
var query = base.prepareRequestQuery();
expect(query).to.contain('ori');
expect(query).to.contain('cgk');
expect(query).to.contain('dst');
expect(query).to.contain('sub');
next();
```

<a name="base-class-preparedatabasequery"></a>
## prepareDatabaseQuery
should return query for db.

```js
var base = new Base(options);
var query = base.prepareDatabaseQuery();
expect(query.query.filtered.filter.and.length).to.eq(5);
next();
```

should return query for db with a transit.

```js
options.dt.transit = 'pnk';
var base = new Base(options);
var query = base.prepareDatabaseQuery();
expect(query.query.filtered.filter.and.length).to.eq(6);
next();
```

should return query for db with two transit.

```js
options.dt.transit2 = 'pdg';
var base = new Base(options);
var query = base.prepareDatabaseQuery();
expect(query.query.filtered.filter.and.length).to.eq(7);
next();
```

should return query for db with three transit.

```js
options.dt.transit3 = 'bdo';
var base = new Base(options);
var query = base.prepareDatabaseQuery();
expect(query.query.filtered.filter.and.length).to.eq(8);
next();
```

<a name="base-class-preparepricesoutputfromdb"></a>
## preparePricesOutputFromDB
should prepare prices output from db.

```js
var base = new Base();
var prices = ''
next();
```

<a name="base-class-getcache"></a>
## getCache
<a name="base-class-preparepricesinputtodb"></a>
## preparePricesInputToDB
should prepare prices output from db.

```js
var base = new Base();
var prices = ''
next();
```

<a name="base-class-savecache"></a>
## saveCache
should save cache to database.

```js
var options = {
	airline: 'lion',
	dt     : {
		ori       : 'jog',
		dst       : 'pnk',
		flightCode: 'abc',
		classCode : 'xx',
	},
};
var base = new Base(options);
var price = {
	"adult" : 1000000,
	"child" : 1000000,
	"infant": 50000,
	"basic" : 1000000,
}
base.saveCache(price, function (err, res) {
	if (err)
		return next(err);
	// console.log(res);
	try{res = JSON.parse(res); } catch(err){return next(err)}
	expect(res.created).to.exist;
	expect(res._index).to.eq(base.index);
	expect(res._type).to.eq(base.type);
	return next();
});
```

<a name="base-class-generateid"></a>
## generateId
should generate id based on data.

```js
var data = {
	origin     : 'cgk',
	destination: 'sub',
	airline    : 'lion',
	flight     : 'abc',
	class      : 'xx',
	prices     : {}
};
var base = new Base();
var id = base.generateId(data);
expect(id).to.eq('cgksublionabcxx')
next();
```

<a name="base-class-get"></a>
## get
should get price from scrape -- function.

```js
var scrapeFn = function (data) {
	return Promise.resolve({
		"success": true,
		"body": {"basic": 2616000, "tax": 266600, "total": 2882600 }
	});
}
var options = {
	scrape: scrapeFn,
	dt: {ori: 'cgk', dst: 'jog', },
	airline: 'garuda'
}
var base = new Base(options);
base.get(100)
	.then(function (res) {
		var body = res.body;
		expect(body).to.exist;
		next();
	})
	.catch(function (err) {
		next(err);
	})
```

<a name="base-class-calculateprices"></a>
## calculatePrices
should return prices formatted from results.

```js
var childPrototype = {
	calculateAdult: function (results) {
		var _100 = results[0];
		return _100.total
	},
	calculateChild: function (results) {
		var _100 = results[0];
		var _110 = results[1];
		return _110.total - _100.total;
	},
	calculateInfant: function (results) {
		var _100 = results[0];
		var _101 = results[2];
		return _101.total - _100.total;
	},
	calculateBasic: function (results) {
		var _100 = results[0];
		return _100.basic
	},
}
var ChildBase = Base.extend(childPrototype);
var child = new ChildBase;
var results = [ { basic: 2616000, tax: 266600, total: 2882600 },
	{ basic: 4578000, tax: 467800, total: 5045800 },
	{ basic: 2878000, tax: 297800, total: 3175800 } ];
var prices = child.calculatePrices(results);
expect(prices.adult).to.exist;
expect(prices.child).to.exist;
expect(prices.infant).to.exist;
expect(prices.basic).to.exist;
next();
```

<a name="base-class-iscachecomplete"></a>
## isCacheComplete
should false if cache incomplete -- lack of property.

```js
var cache = {'adult': 1000000 };
var base = new Base();
var success = base.isCacheComplete(cache);
expect(success).to.not.ok;
next();
```

should false if cache complete -- price less than 0.

```js
var cache = {'adult': 1000000, 'child': -1000000, 'infant': 1000000, 'basic': 1000000, };
var base = new Base();
var success = base.isCacheComplete(cache);
expect(success).to.not.ok;
next();
```

should true if cache complete.

```js
var cache = {'adult': 1000000, 'child': 1000000, 'infant': 1000000, 'basic': 1000000, };
var base = new Base();
var success = base.isCacheComplete(cache);
expect(success).to.ok;
next();
```

<a name="citilink"></a>
# Citilink
<a name="citilink-run"></a>
## run
should check db and then scrape and then save .

```js
var dt = {
	rute       : 'OW',
	ori        : 'SUB',
	dst        : 'CGK',
	adult      : '1',
	child      : '0',
	infant     : '0',
	dep_date   : '27+11+2014',
	id_maskapai: '9',
	user       : 'mitrabook',
	rute       : 'OW',
	dep_radio  : '1Fare6',
	_          : '1416361230832',
}
var urlAirbinder = 'http://128.199.251.75:4/price';
var urlPluto = 'http://pluto.dev/0/price/citilink';
var options = {
	scrape: urlAirbinder,
	dt: dt,
	airline: 'citilink'
};
var citilink = new Citilink(options);
citilink.run()
	.then(function (prices) {
		console.log(prices);
		expect(prices.adult).to.exist;
		expect(prices.child).to.exist;
		expect(prices.infant).to.exist;
		expect(prices.basic).to.exist;
		next();
	})
	.catch(function (err) {
		return next(err);
	});
```

<a name="express"></a>
# Express
<a name="express-run"></a>
## run
should check db and then scrape and then save .

```js
var dt = {
	rute       : 'OW',
	ori        : 'JOG',
	dst        : 'PNK',
	adult      : '1',
	child      : '0',
	infant     : '0',
	dep_date   : '30+11+2014',
	id_maskapai: '9',
	user       : '35054',
	id_maskapai: '9',
	rute       : 'OW',
	dep_radio  : 'normal',
	_          : '1416361230832',
}
var urlAirbinder = 'http://128.199.251.75:8097/price';
var urlPluto = 'http://pluto.dev/0/price/express';
var options = {
	scrape: urlAirbinder,
	dt: dt,
	airline: 'express'
};
var express = new Express(options);
express.run()
	.then(function (prices) {
		// console.log(prices);
		expect(prices.adult).to.exist;
		expect(prices.child).to.exist;
		expect(prices.infant).to.exist;
		expect(prices.basic).to.exist;
		next()
	})
	.catch(function (err) {
		return next(err);
	});
```

<a name="garuda"></a>
# Garuda
<a name="garuda-run"></a>
## run
<a name="lion"></a>
# Lion
<a name="lion-run"></a>
## run
should check db and then scrape and then save .

```js
var dt = {
	rute       : 'OW',
	ori        : 'SUB',
	dst        : 'CGK',
	adult      : '1',
	child      : '0',
	infant     : '0',
	dep_date   : '27+Nov+2014',
	id_maskapai: '9',
	user       : 'ndebomitra',
	rute       : 'OW',
	dep_radio  : 'M0_C0_F0_S5',
	dep_last_radio  : 'M0_C0_F0',
	_          : '1416361230832',
}
var urlAirbinder = 'http://128.199.251.75:2/price';
var urlPluto = 'http://pluto.dev/0/price/lion';
var options = {
	scrape: urlAirbinder,
	dt: dt,
	airline: 'lion'
};
var lion = new Lion(options);
lion.run()
	.then(function (prices) {
		console.log(prices);
		expect(prices.adult).to.exist;
		expect(prices.child).to.exist;
		expect(prices.infant).to.exist;
		expect(prices.basic).to.exist;
		next();
	})
	.catch(function (err) {
		return next(err);
	});
```

<a name="sriwijaya"></a>
# Sriwijaya
<a name="sriwijaya-run"></a>
## run
should check db and then scrape and then save .

```js
var dt = {
	rute       : 'OW',
	ori        : 'SUB',
	dst        : 'CGK',
	adult      : '1',
	child      : '0',
	infant     : '0',
	dep_date   : '27+11+2014',
	id_maskapai: '9',
	user       : 'DEPAG0101',
	rute       : 'OW',
	dep_radio  : 'SJ+267_E',
	dep_last_radio  : 'M0_C0_F0',
	_          : '1416361230832',
}
var urlAirbinder = 'http://128.199.251.75:9019/price';
var urlPluto = 'http://pluto.dev/0/price/sriwijaya';
var options = {
	scrape: urlAirbinder,
	dt: dt,
	airline: 'sriwijaya'
};
var sriwijaya = new Sriwijaya(options);
sriwijaya.run()
	.then(function (prices) {
		console.log(prices);
		expect(prices.adult).to.exist;
		expect(prices.child).to.exist;
		expect(prices.infant).to.exist;
		expect(prices.basic).to.exist;
		next();
	})
	.catch(function (err) {
		return next(err);
	});
```

